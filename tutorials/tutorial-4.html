<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>State structs | Anchor</title>
    <meta name="generator" content="VuePress 1.8.2">
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/anchor/assets/css/0.styles.3c0a719b.css" as="style"><link rel="preload" href="/anchor/assets/js/app.bd358ae2.js" as="script"><link rel="preload" href="/anchor/assets/js/2.dc4d5ee0.js" as="script"><link rel="preload" href="/anchor/assets/js/17.09d046a2.js" as="script"><link rel="prefetch" href="/anchor/assets/js/10.b3c07dc3.js"><link rel="prefetch" href="/anchor/assets/js/11.3097a748.js"><link rel="prefetch" href="/anchor/assets/js/12.744dac96.js"><link rel="prefetch" href="/anchor/assets/js/13.45b77c5e.js"><link rel="prefetch" href="/anchor/assets/js/14.b19c9dfe.js"><link rel="prefetch" href="/anchor/assets/js/15.4516480b.js"><link rel="prefetch" href="/anchor/assets/js/16.4e5fdcee.js"><link rel="prefetch" href="/anchor/assets/js/18.b9c3179f.js"><link rel="prefetch" href="/anchor/assets/js/19.d676a4d2.js"><link rel="prefetch" href="/anchor/assets/js/3.be73de15.js"><link rel="prefetch" href="/anchor/assets/js/4.4d31d94d.js"><link rel="prefetch" href="/anchor/assets/js/5.569bfa89.js"><link rel="prefetch" href="/anchor/assets/js/6.498ab014.js"><link rel="prefetch" href="/anchor/assets/js/7.7e550121.js"><link rel="prefetch" href="/anchor/assets/js/8.a7b1f562.js"><link rel="prefetch" href="/anchor/assets/js/9.b751af4a.js">
    <link rel="stylesheet" href="/anchor/assets/css/0.styles.3c0a719b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/anchor/" class="home-link router-link-active"><!----> <span class="site-name">Anchor</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/project-serum/anchor" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/project-serum/anchor" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting Started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/anchor/getting-started/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/anchor/getting-started/installation.html" class="sidebar-link">Installing Dependencies</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Programs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/anchor/tutorials/tutorial-0.html" class="sidebar-link">A Minimal Example</a></li><li><a href="/anchor/tutorials/tutorial-1.html" class="sidebar-link">Arguments and Accounts</a></li><li><a href="/anchor/tutorials/tutorial-2.html" class="sidebar-link">Account Constraints and Access Control</a></li><li><a href="/anchor/tutorials/tutorial-3.html" class="sidebar-link">Cross Program Invocations (CPI)</a></li><li><a href="/anchor/tutorials/tutorial-4.html" aria-current="page" class="active sidebar-link">State structs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#clone-the-repo" class="sidebar-link">Clone the Repo</a></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#defining-a-program" class="sidebar-link">Defining a Program</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#how-it-works" class="sidebar-link">How it works</a></li></ul></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#using-the-client" class="sidebar-link">Using the client</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#invoke-the-constructor" class="sidebar-link">Invoke the constructor</a></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#fetch-the-state" class="sidebar-link">Fetch the state</a></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#invoke-an-instruction" class="sidebar-link">Invoke an instruction</a></li></ul></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#cpi" class="sidebar-link">CPI</a></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#conclusion" class="sidebar-link">Conclusion</a></li><li class="sidebar-sub-header"><a href="/anchor/tutorials/tutorial-4.html#next-steps" class="sidebar-link">Next Steps</a></li></ul></li><li><a href="/anchor/tutorials/tutorial-5.html" class="sidebar-link">Errors</a></li><li><a href="/anchor/tutorials/tutorial-6.html" class="sidebar-link">Associated Accounts</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CLI</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/anchor/cli/commands.html" class="sidebar-link">Commands</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="state-structs"><a href="#state-structs" class="header-anchor">#</a> State structs</h1> <p>Up until now, we've treated programs on Solana as stateless, using accounts to persist
state between instruction invocations. In this tutorial, we'll give Solana programs the
illusion of state by introducing state structs, which define program account
singletons that can be operated over like any other account.</p> <h2 id="clone-the-repo"><a href="#clone-the-repo" class="header-anchor">#</a> Clone the Repo</h2> <p>To get started, clone the repo.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> clone https://github.com/project-serum/anchor
</code></pre></div><p>And change directories to the <a href="https://github.com/project-serum/anchor/tree/master/examples/tutorial/basic-4" target="_blank" rel="noopener noreferrer">example<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> anchor/examples/tutorial/basic-4
</code></pre></div><h2 id="defining-a-program"><a href="#defining-a-program" class="header-anchor">#</a> Defining a Program</h2> <div class="language-rs extra-class"><pre class="language-rs"><code><span class="token keyword">use</span> <span class="token namespace">anchor_lang<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[program]</span>
<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">basic_4</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token attribute attr-name">#[state]</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Counter</span> <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> authority<span class="token punctuation">:</span> <span class="token class-name">Pubkey</span><span class="token punctuation">,</span>
        <span class="token keyword">pub</span> count<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">impl</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Auth</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span>
                authority<span class="token punctuation">:</span> <span class="token operator">*</span>ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>authority<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">increment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> ctx<span class="token punctuation">:</span> <span class="token class-name">Context</span><span class="token operator">&lt;</span><span class="token class-name">Auth</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>authority <span class="token operator">!=</span> ctx<span class="token punctuation">.</span>accounts<span class="token punctuation">.</span>authority<span class="token punctuation">.</span>key <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span><span class="token punctuation">::</span><span class="token class-name">Unauthorized</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token attribute attr-name">#[derive(Accounts)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Auth</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[account(signer)]</span>
    authority<span class="token punctuation">:</span> <span class="token class-name">AccountInfo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'info</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div><p>Unlike the previous examples, all the instructions here not only take in an <code>Accounts</code>
struct, but they also operate over a mutable, global account marked by the <code>#[state]</code>
attribute. Every instruction defined in the corresponding <code>impl</code> block will have access
to this account, making it a great place to store global program state.</p> <h3 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How it works</h3> <p>We are able to give a program the illusion of state by adopting conventions in the framework.  When invoking the <code>new</code> constructor, Anchor will automatically create a
program-owned account inside the program itself, invoking the system program's <a href="https://docs.rs/solana-program/1.5.5/solana_program/system_instruction/fn.create_account_with_seed.html" target="_blank" rel="noopener noreferrer">create_account_with_seed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> instruction, using <code>Pubkey::find_program_address(&amp;[], program_id)</code> as the <strong>base</strong> and a deterministic string as the <strong>seed</strong> (the string doesn't
matter, as long as the framework is consistent).</p> <p>This all has the effect of
giving the <code>#[state]</code> account a deterministic address, and so as long as all clients
and programs adopt this convention, programs can have the illusion of state in addition
to the full power of the lower level Solana accounts API. Of course, Anchor will handle this all for you, so you never have to worry about these details.</p> <h2 id="using-the-client"><a href="#using-the-client" class="header-anchor">#</a> Using the client</h2> <h3 id="invoke-the-constructor"><a href="#invoke-the-constructor" class="header-anchor">#</a> Invoke the constructor</h3> <p>To access the <code>#[state]</code> account and associated instructions, one can use the
<code>anchor.state</code> namespace on the client. For example, to invoke the constructor,</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Initialize the program's state struct.</span>
<span class="token keyword">await</span> program<span class="token punctuation">.</span>state<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  accounts<span class="token operator">:</span> <span class="token punctuation">{</span>
    authority<span class="token operator">:</span> provider<span class="token punctuation">.</span>wallet<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>Note that the constructor can only be invoked once per program. All subsequent calls
to it will fail, since, as explained above, an account at a deterministic address
will be created.</p> <h3 id="fetch-the-state"><a href="#fetch-the-state" class="header-anchor">#</a> Fetch the state</h3> <p>To fetch the state account,</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> program<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><h3 id="invoke-an-instruction"><a href="#invoke-an-instruction" class="header-anchor">#</a> Invoke an instruction</h3> <p>To invoke an instruction,</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> program<span class="token punctuation">.</span>state<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  accounts<span class="token operator">:</span> <span class="token punctuation">{</span>
    authority<span class="token operator">:</span> provider<span class="token punctuation">.</span>wallet<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><h2 id="cpi"><a href="#cpi" class="header-anchor">#</a> CPI</h2> <p>Performing CPI from one Anchor program to another's state methods is very similar to performing CPI to normal Anchor instructions, except for two differences:</p> <ol><li>All the generated instructions are located under the <code>&lt;my_program&gt;::cpi::state</code> module.</li> <li>One must use a <a href="https://docs.rs/anchor-lang/latest/anchor_lang/struct.CpiStateContext.html" target="_blank" rel="noopener noreferrer">CpiStateContext<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, instead of a `<a href="https://docs.rs/anchor-lang/latest/anchor_lang/struct.CpiContext.html" target="_blank" rel="noopener noreferrer">CpiContext<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ol> <p>For a full example, see the <code>test_state_cpi</code> instruction, <a href="https://github.com/project-serum/anchor/blob/master/examples/misc/programs/misc/src/lib.rs#L39" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>Using state structs is intuitive. However, due to the fact that accounts
on Solana have a fixed size, applications often need to use accounts
directly in addition to <code>#[state]</code> stucts.</p> <h2 id="next-steps"><a href="#next-steps" class="header-anchor">#</a> Next Steps</h2> <p>Next we'll discuss errors.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/anchor/tutorials/tutorial-3.html" class="prev">
        Cross Program Invocations (CPI)
      </a></span> <span class="next"><a href="/anchor/tutorials/tutorial-5.html">
        Errors
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/anchor/assets/js/app.bd358ae2.js" defer></script><script src="/anchor/assets/js/2.dc4d5ee0.js" defer></script><script src="/anchor/assets/js/17.09d046a2.js" defer></script>
  </body>
</html>
